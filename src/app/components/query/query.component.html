<!-- Request Configuration -->
<div class="flex flex-col h-full">
    <form [formGroup]="form" (ngSubmit)="submit()">
        <div>
            <div class="my-6">
                <h5 class="mb-2 font-bold opacity-100 leading-lg">Search</h5>
                <h6 class="leading-lg text-text-secondary">
                    Please select a search type and input an entity name or range to search the Open Enzyme Database.
                </h6>
            </div>

            <div class="flex flex-col gap-6">
                <form [formGroup]="form">
                    <p-panel>
                        <ng-template pTemplate="header">
                            <h6 class="grow">Input</h6>
                            <div class="flex gap-2 -my-1">
                                <button
                                    type="button"
                                    class="flex items-center btn-outline"
                                    (click)="useExample()"
                                >
                                    <i class="mr-2 pi pi-box"></i>
                                    Use an Example
                                </button>
                                <button
                                    type="button"
                                    class="rounded-lg border border-[--surface-d] p-2"
                                    (click)="viewAllData()"
                                >
                                    <i class="mr-2 pi pi-table"></i>
                                    View All Data
                                </button>
                                <button
                                    type="button"
                                    class="rounded-lg border border-[--surface-d] p-2"
                                    (click)="clearAll()"
                                >
                                    Reset Search
                                </button>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="content">
                            <div class="p-4 flex flex-col gap-4">
                                <app-query-input formControlName="search"/>
                                <div class="flex items-center justify-end">
                                    <!-- <button
                                        type="button"
                                        class="rounded-lg border border-[--surface-d] p-2 bg-[--surface-b] flex items-center px-3"
                                        disabled
                                        (click)="clearAll()"
                                    >
                                        <i class="mr-2 pi pi-plus"></i>
                                        Add Search Criteria
                                    </button> -->
                                    <button
                                        type="button"
                                        class="rounded-lg border border-[--surface-d] p-3 px-8 bg-[--primary-color] text-white font-semibold"
                                        (click)="submit()"
                                    >
                                        Search Open Enzyme Database
                                    </button>
                                </div>
                            </div>
                        </ng-template>
                    </p-panel>
                </form>
            </div>
        </div>
    </form>

    <div *ngIf="result" 
        id="container-experimental-data" 
        class="my-4"
    >
        <p-panel>
            <ng-template pTemplate="header">
                <span class="grow">Experimental Data</span>
                <div class="flex items-center gap-2">
                    <button
                        class="btn-outline !flex items-center gap-2"
                        (click)="showFilter = !showFilter"
                    >
                        <i class="pi pi-filter"></i>
                        <h6 class="inline leading-lg">Filter</h6>
                    </button>
                    <button
                        class="btn-outline"
                        (click)="clearAllFilters()"
                    >
                        Clear All
                    </button>
                </div>
            </ng-template>

            <div class="flex flex-col">
                <div *ngIf="showFilter" id="container-filters" class="flex flex-col gap-2 w-full gap-4 p-2 px-4 bg-white">
                    <div class="font-semibold">Current Filters</div>
                    <div class="flex gap-2">
                        <span class="rounded-sm bg-[--surface-d] p-1 flex items-center gap-1">
                            Filter 1
                            <i class="pi pi-times-circle cursor-pointer"></i>
                        </span>
                    </div>
                </div>

                <hr *ngIf="showFilter" />

                <div class="flex w-full">
                    <p-table
                        #resultsTable
                        [value]="result.data"

                        [rows]="10"
                        [rowsPerPageOptions]="[10, 20, 50]"
                        [paginator]="true"

                        dataKey="iid"

                        class="w-full h-full"
                        tableStyleClass="w-full"
                        styleClass="w-full"
                    >
                        <ng-template pTemplate="header">
                            <tr>
                                <th class="align-middle">Reaction</th>
                                <th class="align-middle">Compound</th>
                                <th class="align-middle">Organism</th>
                                <th class="align-middle">Uniprot ID</th>
                                <th class="align-middle">EC Number</th>
                                <th class="align-middle">pH</th>
                                <th class="align-middle">Temp (°C)</th>
                                <th class="align-middle">Kcat (s⁻¹)</th>
                                <th class="align-middle">Km (mM)</th>
                                <th class="align-middle">Kcat/Km (M⁻¹s⁻¹)</th>
                                <th class="align-middle">Literature</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-row let-expanded="expanded">
                            <tr>
                                <td class="align-middle">
                                    <div class="flex gap-2 items-center">
                                        <button title="Expand" type="button" [pRowToggler]="row">
                                            <i [class]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></i>
                                        </button>
                                        <span>{{ row.reaction || 'template reaction string'}}</span>
                                    </div>
                                </td>
                                <td class="align-middle">{{ row.compound.name }}</td>
                                <td class="align-middle">{{ row.organism }}</td>
                                <td class="align-middle">{{ row.uniprot_id }}</td>
                                <td class="align-middle">{{ row.ec_number }}</td>
                                <td class="align-middle">{{ row.ph }}</td>
                                <td class="align-middle">{{ row.temperature }}</td>
                                <td class="align-middle">{{ row.kcat }}</td>
                                <td class="align-middle">{{ row.km }}</td>
                                <td class="align-middle">{{ row.kcat_km }}</td>
                                <td class="align-middle">
                                    <ng-container *ngTemplateOutlet="externalLink; context: { 
                                        $implicit: {
                                            url: 'https://pubmed.ncbi.nlm.nih.gov/' + row.pubmed_id,
                                            label: row.pubmed_id
                                        }
                                    }"></ng-container>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="rowexpansion" let-row>
                            <tr>
                                <td colspan="11" class="relative overflow-hidden no-scrollbar bg-[#F7FAFF] !p-2">
                                    <div class="rounded-md border border-[--surface-d] border-solid bg-white p-2 flex gap-2 w-full">
                                        <div class="flex flex-col gap-2 w-1/2">
                                            <div class="font-bold">Experimental Information</div>
                                            <div class="flex justify-between">
                                                <div>Organism</div>
                                                <div class="text-end italic">{{ row.organism }}</div>
                                            </div>
                                            <div class="flex justify-between">
                                                <div>Uniprot ID</div>
                                                <div>
                                                    @for (id of row.uniprot_id; track id) {
                                                        <ng-container *ngTemplateOutlet="externalLink; context: { 
                                                            $implicit: {
                                                                url: 'https://www.uniprot.org/uniprotkb/' + id + '/entry',
                                                                label: id
                                                            }
                                                        }"></ng-container>
                                                    }
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <div>EC Number</div>
                                                <div class="text-end">
                                                    <ng-container *ngTemplateOutlet="externalLink; context: { 
                                                        $implicit: {
                                                            url: 'https://www.brenda-enzymes.org/enzyme.php?ecno=' + row.ec_number,
                                                            label: row.ec_number
                                                        }
                                                    }"></ng-container>
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <div>PubMed ID</div>
                                                <div class="text-end">
                                                    <ng-container *ngTemplateOutlet="externalLink; context: { 
                                                        $implicit: {
                                                            url: 'https://pubmed.ncbi.nlm.nih.gov/' + row.pubmed_id,
                                                            label: row.pubmed_id
                                                        }
                                                    }"></ng-container>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="w-[1px] bg-[--surface-d]"></div>
                                        <div class="w-1/2">
                                            <div class="font-bold">Reaction Scheme</div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
            
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="11" class="text-center">
                                    <div class="flex flex-col items-center justify-center h-full gap-4 p-8">
                                    <h5 class="font-semibold text-center">Empty</h5>
                                    <p class="text-center">No routes found. Please try again with different parameters.</p>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>
        </p-panel>
    </div>
</div>

<ng-template #externalLink let-linkItem>
    <a [href]="linkItem.url" target="_blank" class="flex items-center gap-1 text-[#0080FF] font-semibold">
        <p>{{ linkItem.label }}</p>
        <i class="pi pi-external-link"></i>
    </a>
</ng-template>

<p-dialog [(visible)]="showFilter" styleClass="w-[800px] h-[800px]">
    <ng-template pTemplate="header">
        <div class="flex items-center gap-2 font-semibold">
            <i class="px-2 pi pi-filter"></i>
            Filter
        </div>
    </ng-template>
    <div class="mx-4 h-full">
        <div class="flex w-full h-full grow gap-4">
            <div class="w-1/2 flex flex-col gap-4 p-3">
                <div class="font-bold">Experimental Parameters</div>
                @for (filter of filterRecordsByCategory['parameter']; track filter.label) {
                    <div class="flex flex-col gap-2">
                        <div>{{ filter.label }}</div>
                        <p-multiSelect
                            styleClass="w-full"
                            [placeholder]="filter.placeholder"
                            [options]="filter.options"
                            [(ngModel)]="filter.value"
                            [virtualScroll]="true"
                            [virtualScrollItemSize]="48"
                            (onChange)="resultsTable.filter(filter.value, filter.field, 'in')"
                        ></p-multiSelect>
                    </div>
                }
            </div>
            <div class="w-1/2 border-l border-solid border-[--surface-d] p-3 pl-7 flex flex-col gap-4">
                <div class="font-bold">Enzyme Kinetics</div>
                @for (filter of filterRecordsByCategory['enzyme']; track filter.label) {
                    <div class="flex flex-col gap-2">
                        <div>{{ filter.label }}</div>
                        <p-multiSelect
                            styleClass="w-full"
                            [placeholder]="filter.placeholder"
                            [options]="filter.options"
                            [(ngModel)]="filter.value"
                            [virtualScroll]="true"
                            [virtualScrollItemSize]="48"
                            (onChange)="resultsTable.filter(filter.value, filter.field, 'in')"
                        ></p-multiSelect>
                    </div>
                }
                <hr class="-mx-7"/>
                <div class="font-bold">Literature</div>
                @for (filter of filterRecordsByCategory['literature']; track filter.label) {
                    <div class="flex flex-col gap-2">
                        <div>{{ filter.label }}</div>
                        <p-multiSelect
                            styleClass="w-full"
                            [placeholder]="filter.placeholder"
                            [options]="filter.options"
                            [(ngModel)]="filter.value"
                            [virtualScroll]="true"
                            [virtualScrollItemSize]="48"
                            (onChange)="resultsTable.filter(filter.value, filter.field, 'in')"
                        ></p-multiSelect>
                    </div>
                }
                <hr class="-mx-7"/>
            </div>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <div class="flex items-center justify-between pt-4">
            <p-button outlined class="bg-white" (onClick)="clearAllFilters(); showFilter = false">
                Reset Filters
            </p-button>
            <p-button (onClick)="applyFilters(); showFilter = false">
                Apply Filters
            </p-button>
        </div>
    </ng-template>
</p-dialog>
