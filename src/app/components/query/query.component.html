<!-- Request Configuration -->
<div class="flex flex-col h-full">
    <form [formGroup]="form" (ngSubmit)="submit()">
        <div>
            <div class="my-6 flex items-center justify-between">
                <div>
                    <h5 class="mb-2 font-bold opacity-100 leading-lg">Search</h5>
                    <h6 class="leading-lg text-text-secondary">
                        Please select a search type and input an entity name or range to search the Open Enzyme
                        Database.
                    </h6>
                </div>

                @if (result.status === 'loaded') {
                <div class="flex flex-col justify-center">
                    <button class="p-3 px-4 text-white border rounded-md bg-primary" title="Export" type="button"
                        (click)="resultsTable.exportCSV()">
                        <i class="mr-2 pi pi-download"></i>
                        <span class="font-semibold">Export</span>
                    </button>
                </div>
                }
            </div>

            <div class="flex flex-col gap-6">
                <form [formGroup]="form">
                    <p-panel>
                        <ng-template pTemplate="header">
                            <h6 class="grow">Input</h6>
                            <div class="flex gap-2 -my-1">
                                <button type="button" class="flex items-center btn-outline"
                                    (click)="useExampleMenu.toggle($event)">
                                    <i class="mr-2 pi pi-box"></i>
                                    Use an Example
                                    <p-menu #useExampleMenu styleClass="w-[300px]" [model]="exampleRecords"
                                        [popup]="true" />
                                </button>
                                <button type="button" class="rounded-lg border border-[--surface-d] p-2"
                                    (click)="viewAllData()">
                                    <i class="mr-2 pi pi-table"></i>
                                    View All Data
                                </button>
                                <button type="button" class="rounded-lg border border-[--surface-d] p-2 disabled:opacity-50"
                                    [disabled]="form.value.search === null"
                                    (click)="clearAll()">
                                    Reset Search
                                </button>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="content">
                            <div class="p-4 flex flex-col gap-4">
                                <app-query-input formControlName="search" />
                                <div class="flex items-center justify-end">
                                    <!-- <button
                                        type="button"
                                        class="rounded-lg border border-[--surface-d] p-2 bg-[--surface-b] flex items-center px-3"
                                        disabled
                                        (click)="clearAll()"
                                    >
                                        <i class="mr-2 pi pi-plus"></i>
                                        Add Search Criteria
                                    </button> -->
                                    <button type="button"
                                        class="rounded-lg border border-[--surface-d] p-3 px-8 bg-[--primary-color] text-white font-semibold"
                                        (click)="submit()">
                                        Search Open Enzyme Database
                                    </button>
                                </div>
                            </div>
                        </ng-template>
                    </p-panel>
                </form>
            </div>
        </div>
    </form>

    @if (result.status === 'loaded') {
    <div id="container-experimental-data" class="my-4">
        <p-panel>
            <ng-template pTemplate="header">
                <span class="grow">Experimental Data</span>
                <div class="flex items-center gap-2">
                    <button class="btn-outline !flex items-center gap-2" (click)="showFilter = !showFilter">
                        <i class="pi pi-filter"></i>
                        <h6 class="inline leading-lg">Filter</h6>
                    </button>
                    <button class="btn-outline" (click)="clearAllFilters()">
                        Clear All
                    </button>
                </div>
            </ng-template>

            <div class="flex flex-col">
                @if (hasFilter) {
                <div id="container-filters" class="flex flex-col gap-2 w-full gap-4 p-2 px-4 bg-white">
                    <div class="font-semibold">Current Filters</div>
                    <div class="flex gap-2">
                        @for (filter of filterRecords; track filter.label) {
                        @if (filter.hasFilter()) {
                        <span class="rounded-sm bg-[--surface-d] p-1 flex items-center gap-1">
                            <div [innerHTML]="filter.label.value"></div>: {{ filter.formattedValue }}
                            <i class="pi pi-times-circle cursor-pointer" (click)="
                                                filter.value = filter.defaultValue;
                                                applyFilters();
                                            "></i>
                        </span>
                        }
                        }
                    </div>
                </div>

                <hr />
                }

                <div class="flex w-full">
                    <p-table #resultsTable [value]="result.data" [rows]="10" [rowsPerPageOptions]="[10, 20, 50]"
                        [paginator]="true" dataKey="iid" class="w-full h-full" tableStyleClass="w-full"
                        (onRowExpand)="onRowExpand($event)"
                        styleClass="w-full" [columns]="columns">
                        <ng-template pTemplate="header">
                            <tr>
                                <!-- <th class="align-middle">Reaction</th> -->
                                <th class="align-middle relative group" pSortableColumn="compound.name">
                                    <span>Compound</span>
                                    <p-sortIcon class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible" field="compound.name" />
                                </th>
                                <th class="align-middle relative group" pSortableColumn="organism">
                                    <span>Organism</span>
                                    <p-sortIcon class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible" field="organism" />
                                </th>
                                <th class="align-middle relative group" pSortableColumn="uniprot_id">
                                    <span>Uniprot ID</span>
                                    <p-sortIcon class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible" field="uniprot_id" />
                                </th>
                                <th class="align-middle relative group" pSortableColumn="ec_number">
                                    <span>EC Number</span>
                                    <p-sortIcon class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible" field="ec_number" />
                                </th>
                                <th class="align-middle relative group" pSortableColumn="enzyme_type">
                                    <span>Enzyme Type</span>
                                    <p-sortIcon class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible" field="enzyme_type" />
                                </th>
                                <th class="align-middle relative group" pSortableColumn="ph">
                                    <span [innerHTML]="filters['ph'].label.value"></span>
                                    <p-sortIcon class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible" field="ph" />
                                </th>
                                <th class="align-middle relative group min-w-[80px]" pSortableColumn="temperature">
                                    <span>Temp (Â°C)</span>
                                    <p-sortIcon class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible" field="temperature" />
                                </th>
                                <th class="align-middle relative group min-w-[100px]" pSortableColumn="kcat">
                                    <span class="italic">k</span><sub>cat</sub><br/>(s<sup class="text-xs"> -1</sup>)
                                    <p-sortIcon class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible" field="kcat" />
                                </th>
                                <th class="align-middle relative group min-w-[100px]" pSortableColumn="km">
                                    <span class="italic">K</span><sub>m</sub><br/>(mM)
                                    <p-sortIcon class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible" field="km" />
                                </th>
                                <th class="align-middle relative group min-w-[120px]" pSortableColumn="kcat_km">
                                    <span class="italic">k</span><sub>cat</sub>/<span class="italic">K</span><sub>m</sub><br/>(mM<sup class="text-xs"> -1</sup>s<sup class="text-xs"> -1</sup>)
                                    <p-sortIcon class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible" field="kcat_km" />
                                </th>
                                <th class="align-middle relative group" pSortableColumn="pubmed_id">
                                    <span>Literature</span>
                                    <p-sortIcon class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible" field="pubmed_id" />
                                </th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-row let-expanded="expanded">
                            <tr class="table-row">
                                <!-- <td class="align-middle">
                                        <div class="flex gap-2 items-center">
                                            <button title="Expand" type="button" [pRowToggler]="row">
                                                <i [class]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></i>
                                            </button>
                                            <span>{{ row.reaction || 'template reaction string'}}</span>
                                        </div>
                                    </td> -->
                                <td class="align-middle">
                                    <div class="flex items-start gap-2">
                                        <button title="Expand" type="button" [pRowToggler]="row">
                                            <i [class]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></i>
                                        </button>
                                        <div>{{ row.compound.name }}</div>
                                    </div>
                                </td>
                                <td class="align-middle italic">{{ row.organism }}</td>
                                <td class="align-middle">{{ row.uniprot_id }}</td>
                                <td class="align-middle">{{ row.ec_number }}</td>
                                <td class="align-middle">{{ row.enzyme_type }}</td>
                                <td class="align-middle">{{ row.ph }}</td>
                                <td class="align-middle">{{ row.temperature }}</td>
                                <td class="align-middle">{{ row.kcat | number: '1.1-4' }}</td>
                                <td class="align-middle">{{ row.km | number: '1.1-4' }}</td>
                                <td class="align-middle">{{ row.kcat_km | number: '1.1-4' }}</td>
                                <td class="align-middle">
                                    <ng-container *ngTemplateOutlet="externalLink; context: { 
                                        $implicit: {
                                            url: 'https://pubmed.ncbi.nlm.nih.gov/' + row.pubmed_id,
                                            label: row.pubmed_id
                                        }
                                    }">
                                    </ng-container>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="rowexpansion" let-row>
                            <tr>
                                <td colspan="11" class="relative overflow-hidden no-scrollbar bg-[#F7FAFF] !p-2">
                                    <div [@slideIn]
                                        class="rounded-md border border-[--surface-d] border-solid bg-white p-2 flex gap-2 w-full">
                                        <div class="flex flex-col gap-2 w-1/2">
                                            <div class="font-bold">Experiment Information</div>
                                            <div class="flex justify-between">
                                                <div>Organism</div>
                                                <div class="text-end italic">{{ row.organism }}</div>
                                            </div>
                                            <div class="flex justify-between">
                                                <div>Uniprot ID</div>
                                                <div>
                                                    @for (id of row.uniprot_id; track id) {
                                                    <ng-container *ngTemplateOutlet="externalLink; context: { 
                                                                $implicit: {
                                                                    url: 'https://www.uniprot.org/uniprotkb/' + id + '/entry',
                                                                    label: id
                                                                }
                                                            }"></ng-container>
                                                    }
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <div>EC Number</div>
                                                <div class="text-end">
                                                    <ng-container *ngTemplateOutlet="externalLink; context: { 
                                                            $implicit: {
                                                                url: 'https://www.brenda-enzymes.org/enzyme.php?ecno=' + row.ec_number,
                                                                label: row.ec_number
                                                            }
                                                        }"></ng-container>
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <div>PubMed ID</div>
                                                <div class="text-end">
                                                    <ng-container *ngTemplateOutlet="externalLink; context: { 
                                                            $implicit: {
                                                                url: 'https://pubmed.ncbi.nlm.nih.gov/' + row.pubmed_id,
                                                                label: row.pubmed_id
                                                            }
                                                        }"></ng-container>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="w-[1px] bg-[--surface-d]"></div>
                                        <div class="w-1/2 flex flex-col gap-1">
                                            @let schemas = reactionSchemaCache[row.ec_number + '|' + row.compound.name + '|' + row.organism];
                                            <div class="flex items-center justify-between w-full">
                                                <span class="font-bold">Reaction Schema</span>
                                                <small class="italic text-[#6C757D]/75">Found: {{ schemas.data ? schemas.data.length : 'N/A' }}</small>
                                            </div>
                                            @switch (schemas.status) {
                                            @case ('loaded') {
                                            <div class="w-full grow rounded-md border border-[--surface-d] border-solid bg-white flex-col items-center justify-center text-[#6C757D]">
                                                <p-scrollPanel [style]="{ height: '100px', width: '100%' }">
                                                @for (schema of schemas.data; track schema) {
                                                    <app-reaction-schema [reactionSchema]="schema" />
                                                    <hr class="mb-2"/>
                                                }
                                                </p-scrollPanel>
                                            </div>
                                            }
                                            @case ('loading') {
                                            <div
                                                class="w-full grow rounded-md border border-[--surface-d] border-solid bg-white p-2 flex items-center justify-center text-[#6C757D]">
                                                <p-skeleton height="100%" width="100%"></p-skeleton>
                                            </div>
                                            }
                                            @case ('error') {
                                            <div
                                                class="w-full grow rounded-md border border-[--surface-d] border-solid bg-white p-2 flex items-center justify-center text-[#6C757D]">
                                                Error loading reaction schema
                                            </div>
                                            }
                                            @case ('na') {
                                            <div
                                                class="w-full grow rounded-md border border-[--surface-d] border-solid bg-white p-2 flex items-center justify-center text-[#6C757D]">
                                                No reaction schema found
                                            </div>
                                            }
                                            }
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>

                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="11" class="text-center">
                                    <div class="flex flex-col items-center justify-center h-full gap-4 p-8">
                                        <h5 class="font-semibold text-center">Empty</h5>
                                        <p class="text-center">No kinetic data found. Please try a new search.</p>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>
        </p-panel>
    </div>
    }
</div>

<ng-template #externalLink let-linkItem>
    <a [href]="linkItem.url" target="_blank" class="flex items-center gap-1 text-[#0080FF] font-semibold justify-end">
        <p>{{ linkItem.label }}</p>
        <i class="pi pi-external-link"></i>
    </a>
</ng-template>

<p-dialog [(visible)]="showFilter" [modal]="true" styleClass="w-[800px] h-[800px]">
    <ng-template pTemplate="header">
        <div class="flex items-center gap-2 font-semibold">
            <i class="px-2 pi pi-filter"></i>
            Filter
        </div>
    </ng-template>
    <div class="mx-4 h-full">
        <div class="flex w-full h-full grow gap-4">
            <div class="w-1/2 flex flex-col gap-4 p-3">
                <div class="font-bold">Experimental Parameters</div>
                @for (filter of filterRecordsByCategory['parameter']; track filter.label) {
                <div class="flex flex-col gap-2">
                    <div [innerHTML]="filter.label.value"></div>
                    <ng-container *ngTemplateOutlet="filterTemplate; context: { $implicit: filter }"></ng-container>
                </div>
                }
            </div>
            <div class="w-1/2 border-l border-solid border-[--surface-d] p-3 pl-7 flex flex-col gap-4">
                <div class="font-bold">Enzyme Kinetics</div>
                @for (filter of filterRecordsByCategory['enzyme']; track filter.label) {
                <div class="flex flex-col gap-2">
                    <div [innerHTML]="filter.label.value"></div>
                    <ng-container *ngTemplateOutlet="filterTemplate; context: { $implicit: filter }"></ng-container>
                </div>
                }
                <hr class="-mx-7" />
                <div class="font-bold">Literature</div>
                @for (filter of filterRecordsByCategory['literature']; track filter.label) {
                <div class="flex flex-col gap-2">
                    <div [innerHTML]="filter.label.value"></div>
                    <ng-container *ngTemplateOutlet="filterTemplate; context: { $implicit: filter }"></ng-container>
                </div>
                }
                <hr class="-mx-7" />
            </div>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <div class="flex items-center justify-between pt-4">
            <button class="rounded-lg border border-solid border-[--primary-color] py-3 px-5 bg-white text-[--primary-color] text-[1rem]" (click)="clearAllFilters(); showFilter = false">
                Reset Filters
            </button>
            <button class="rounded-lg border border-solid border-[--primary-color] py-3 px-5 bg-[--primary-color] text-white text-[1rem]" (click)="applyFilters(); showFilter = false">
                Show {{ resultsTable.filteredValue?.length ?? this.result!.total }} Result{{
                resultsTable.filteredValue?.length !== this.result!.total ? 's' : '' }}
            </button>
        </div>
    </ng-template>
</p-dialog>


<ng-template #filterTemplate let-filter>
    @switch (filter.type) {
    @case ('multiselect') {
    <p-multiSelect styleClass="w-full" [placeholder]="filter.placeholder" [options]="filter.options"
        [(ngModel)]="filter.value" [virtualScroll]="true" [virtualScrollItemSize]="48"
        (onChange)="searchTable($event, filter)"></p-multiSelect>
    }
    @case ('range') {
    <input pInputText title="{{ filter.placeholder }}" type="text" [placeholder]="filter.placeholder"
        (blur)="searchTable($event, filter)" [value]="filter.formattedValue"
        class="w-full p-3 border border-[#ced4da] rounded-md !text-base"/>
    }
    @default {
    <span>{{ filter.value }}</span>
    <!-- <p-inputText styleClass="w-full" [placeholder]="filter.placeholder" [(ngModel)]="filter.value"></p-inputText> -->
    }
    }
</ng-template>