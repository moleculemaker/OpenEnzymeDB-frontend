<div class="flex flex-col h-full">
    <div class="my-4">
      <p-panel>
        <ng-template pTemplate="header">
          <span class="grow">Experimental Data</span>
          <div class="flex items-center gap-2">
            <button class="btn-outline !flex items-center gap-2" (click)="showFilter = !showFilter">
              <i class="pi pi-filter"></i>
              <h6 class="inline leading-lg">Filter</h6>
            </button>
            <button class="btn-outline" (click)="clearAllFilters()">
              Clear All
            </button>
          </div>
        </ng-template>

        <div class="flex flex-col">
          @if (hasFilter) {
          <div id="container-filters" class="flex flex-col gap-2 w-full gap-4 p-2 px-4 bg-white">
            <div class="font-semibold">Current Filters</div>
            <div class="flex gap-2">
              @for (filter of filterRecords; track filter.label) {
              @if (filter.hasFilter()) {
              <span class="rounded-sm bg-[--surface-d] p-1 flex items-center gap-1">
                <div [innerHTML]="filter.label.value" class="font-semibold"></div>: {{
                filter.formattedValue }}
                <i class="pi pi-times-circle cursor-pointer" (click)="
                                                filter.value = filter.defaultValue;
                                                applyFilters();
                                            "></i>
              </span>
              }
              }
            </div>
          </div>

          <hr />
          }

          <div class="flex w-full">
            <p-table #resultsTable [value]="result.data" [rows]="10" [rowsPerPageOptions]="[10, 20, 50]"
              [paginator]="true" dataKey="iid" class="w-full h-full" tableStyleClass="w-full" styleClass="w-full"
              [columns]="columns">
              <ng-template pTemplate="header">
                <tr>
                  <!-- <th class="align-middle">Reaction</th> -->
                  <th class="align-middle relative group" pSortableColumn="compound.name">
                    <span>Compound</span>
                    <p-sortIcon
                      class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                      field="compound.name" />
                  </th>
                  <th class="align-middle relative group" pSortableColumn="organism">
                    <span>Organism</span>
                    <p-sortIcon
                      class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                      field="organism" />
                  </th>
                  <th class="align-middle relative group" pSortableColumn="uniprot_id">
                    <span>Uniprot ID</span>
                    <p-sortIcon
                      class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                      field="uniprot_id" />
                  </th>
                  <th class="align-middle relative group" pSortableColumn="ec_number">
                    <span>EC Number</span>
                    <p-sortIcon
                      class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                      field="ec_number" />
                  </th>
                  <th class="align-middle relative group" pSortableColumn="enzyme_type">
                    <span>Enzyme Type</span>
                    <p-sortIcon
                      class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                      field="enzyme_type" />
                  </th>
                  <th class="align-middle relative group" pSortableColumn="ph">
                    <span [innerHTML]="filters['ph'].label.value"></span>
                    <p-sortIcon
                      class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                      field="ph" />
                  </th>
                  <th class="align-middle relative group min-w-[100px]" pSortableColumn="temperature">
                    <span>Temp (Â°C)</span>
                    <p-sortIcon
                      class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                      field="temperature" />
                  </th>
                  <th class="align-middle relative group min-w-[100px]" pSortableColumn="kcat">
                    <span class="italic">k</span><sub>cat</sub><br />(s<sup class="text-xs">
                      -1</sup>)
                    <p-sortIcon
                      class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                      field="kcat" />
                  </th>
                  <th class="align-middle relative group min-w-[100px]" pSortableColumn="km">
                    <span class="italic">K</span><sub>m</sub><br />(mM)
                    <p-sortIcon
                      class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                      field="km" />
                  </th>
                  <th class="align-middle relative group min-w-[120px]" pSortableColumn="kcat_km">
                    <span class="italic">k</span><sub>cat</sub>/<span class="italic">K</span><sub>m</sub><br />(mM<sup
                      class="text-xs">
                      -1</sup>s<sup class="text-xs"> -1</sup>)
                    <p-sortIcon
                      class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                      field="kcat_km" />
                  </th>
                  <th class="align-middle relative group" pSortableColumn="pubmed_id">
                    <span>Literature</span>
                    <p-sortIcon
                      class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                      field="pubmed_id" />
                  </th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-row let-expanded="expanded">
                <tr class="table-row">
                  <!-- <td class="align-middle">
                                        <div class="flex gap-2 items-center">
                                            <button title="Expand" type="button" [pRowToggler]="row">
                                                <i [class]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></i>
                                            </button>
                                            <span>{{ row.reaction || 'template reaction string'}}</span>
                                        </div>
                                    </td> -->
                  <td class="align-middle">
                    <div class="flex items-start gap-2">
                      <button title="Expand" type="button" [pRowToggler]="row">
                        <i [class]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></i>
                      </button>
                      <a [routerLink]="['/query/compound', row.compound.name]" class="text-blue-500 cursor-pointer">{{ row.compound.name }}</a>
                    </div>
                  </td>
                  <td class="align-middle italic">{{ row.organism }}</td>
                  <td class="align-middle">
                    <a [routerLink]="['/query/uniprot', row.uniprot_id[0]]" class="text-blue-500 cursor-pointer">{{ row.uniprot_id }}</a>
                  </td>
                  <td class="align-middle">
                    <a [routerLink]="['/query/ec', row.ec_number]" class="text-blue-500 cursor-pointer">{{ row.ec_number }}</a>
                  </td>
                  <td class="align-middle">{{ row.enzyme_type }}</td>
                  <td class="align-middle">{{ row.ph }}</td>
                  <td class="align-middle">{{ row.temperature }}</td>
                  <td class="align-middle">
                    @if (row.kcat) {
                    {{ row.kcat | number: '1.1-4' }}
                    } @else {
                    <span class="opacity-25">N/A</span>
                    }
                  </td>
                  <td class="align-middle">
                    @if (row.km) {
                    {{ row.km | number: '1.1-4' }}
                    } @else {
                    <span class="opacity-25">N/A</span>
                    }
                  </td>
                  <td class="align-middle">
                    @if (row.kcat_km) {
                    {{ row.kcat_km | number: '1.1-4' }}
                    } @else {
                    <span class="opacity-25">N/A</span>
                    }
                  </td>
                  <td class="text-end align-middle">
                    <app-external-link
                      class="justify-end"
                      [linkItem]="{
                        url: 'https://pubmed.ncbi.nlm.nih.gov/' + row.pubmed_id,
                        label: row.pubmed_id
                      }"
                    ></app-external-link>
                  </td>
                </tr>
              </ng-template>
              <ng-template pTemplate="rowexpansion" let-row>
                <tr>
                  <td colspan="11" class="relative overflow-hidden no-scrollbar bg-[#F7FAFF] !p-2">
                    <div [@slideIn]
                      class="rounded-md border border-[--surface-d] border-solid bg-white p-2 flex gap-2 w-full">
                      <div class="flex flex-col gap-2 w-1/2">
                        <div class="font-bold">Experiment Information</div>
                        <div class="flex justify-between">
                          <div>Organism</div>
                          <div class="text-end italic">{{ row.organism }}</div>
                        </div>
                        <div class="flex justify-between">
                          <div>Uniprot ID</div>
                          <div>
                            @for (id of row.uniprot_id; track id) {
                            <app-external-link [linkItem]="{
                                                        url: 'https://www.uniprot.org/uniprotkb/' + id + '/entry',
                                                        label: id
                                                    }"></app-external-link>
                            }
                          </div>
                        </div>
                        <div class="flex justify-between">
                          <div>EC Number</div>
                          <div class="text-end">
                            <app-external-link [linkItem]="{
                                                        url: 'https://www.brenda-enzymes.org/enzyme.php?ecno=' + row.ec_number,
                                                        label: row.ec_number
                                                    }"></app-external-link>
                          </div>
                        </div>
                        <div class="flex justify-between">
                          <div>PubMed ID</div>
                          <div class="text-end">
                            <app-external-link [linkItem]="{
                                                        url: 'https://pubmed.ncbi.nlm.nih.gov/' + row.pubmed_id,
                                                        label: row.pubmed_id
                                                    }"></app-external-link>
                          </div>
                        </div>
                      </div>
                      <div class="w-[1px] bg-[--surface-d]"></div>
                      <div class="w-1/2 flex flex-col gap-1">
                        <div class="font-bold">Reaction Scheme</div>
                        <div
                          class="w-full grow rounded-md border border-[--surface-d] border-solid bg-white p-2 flex items-center justify-center text-[#6C757D]">
                          <span>(Coming Soon)</span>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              </ng-template>

              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="11" class="text-center">
                    <div class="flex flex-col items-center justify-center h-full gap-4 p-8">
                      <h5 class="font-semibold text-center">Empty</h5>
                      <p class="text-center">No kinetic data found. Please try a new search.</p>
                    </div>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </p-panel>
    </div>
  </div>

  <app-filter-dialog [(visible)]="showFilter" [filterRecordsByCategory]="filterRecordsByCategory"
    [numberResults]="$any(resultsTable)?.filteredValue?.length ?? result.total" (filterChange)="searchTable($event)"
    (clearAllFilters)="clearAllFilters()" (applyFilters)="applyFilters()">
  </app-filter-dialog>