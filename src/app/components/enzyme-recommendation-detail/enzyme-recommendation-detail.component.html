<div class="flex flex-col gap-4 max-w-content-xl w-full px-4">
  <div class="flex items-center justify-between pt-10">
    <div class="flex gap-2 items-center">
      <button type="button" title="Back to All Results"
        class="border border-solid border-[#DEE2E6] rounded-sm px-2 py-1 flex items-center gap-2 bg-[#f8f9fa]"
        (click)="backToSearch()">
        <i class="pi pi-arrow-left"></i>
        <span>Back to All Results</span>
      </button>
      @switch (algorithm) {
        @case ('mcs') {
          <h5 class="font-bold mt-0">MCS Results</h5>
        }
        @case ('fragment') {
          <h5 class="font-bold mt-0">Fragment Algorithm Results</h5>
        }
        @case ('tanimoto') {
          <h5 class="font-bold mt-0">Tanimoto Similarity Results</h5>
        }
      }
      <button
        type="button"
        title="copy job id"
        class="border-none cursor-pointer"
      >
        <i class="pi pi-link" (click)="copyAndPasteURL()"></i>
      </button>
    </div>
    <div class="flex items-center gap-2">

      <div id="btn-export" class="flex flex-col justify-center">
        <p-button label="Export" icon="pi pi-download" (onClick)="menu.toggle($event)"></p-button>
        <p-tieredMenu #menu [model]="exportOptions" [popup]="true" />
      </div>
    </div>
  </div>

  <p-panel>
    <ng-template pTemplate="header">
      <span class="grow">Input Substrate</span>
    </ng-template>

    @if (substrate) {
    <div class="flex gap-2 p-2">
      <div class="flex flex-col gap-2 w-1/3 p-2">
        <app-molecule-image #molecule2d
          class="w-full h-full rounded-md border border-solid border-[#DEE2E6] p-2 flex items-center justify-center"
          [smiles]="substrate['smiles']" [width]="200" [height]="200"></app-molecule-image>
      </div>
      <div class="flex flex-col gap-4 w-2/3 border-l border-solid border-[#DEE2E6] p-2">
        <div class="flex flex-col gap-4">
          <div class="flex justify-between">
            <span class="leading-sm text-[#495057]">Name</span>
            <span class="font-semibold text-end leading-base inline-block max-w-[200px] break-words">{{
              substrate['iupac_name'] }}</span>
          </div>
          <div class="flex justify-between">
            <span class="leading-sm text-[#495057]">SMILES</span>
            <span class="font-semibold text-end leading-base inline-block max-w-[200px] break-words">{{
              substrate['smiles'] }}</span>
          </div>
          <div class="flex justify-between">
            <span class="leading-sm text-[#495057]">Matches Returned</span>
            <span class="font-semibold text-end leading-base inline-block max-w-[200px] break-words">{{
              substrate['matches_return'] }}</span>
          </div>
          <hr>
          @switch (algorithm) {
            @case ('mcs') {
              <div>
                <div>
                  <div class="leading-xl">What is 
                    <span class="p-1 text-white font-semibold rounded-md bg-[#726EDE]">MCS Score</span>?
                  </div>
                  <div class="leading-xl italic mt-2">
                    Maximum Common Substructure Score is a numerical value ranging from 0 to 1 representing the size of the largest shared substructure between two molecules, with higher scores indicating greater structural overlap. The top 10 matches for the input substrate are shown below.
                  </div>
                </div>
              </div>
            }
            @case ('tanimoto') {
              <div>
                <div class="leading-xl">What is
                  <span class="p-1 text-black font-semibold rounded-md bg-[#B2FDEF]">Tanimoto Score</span>?
                </div>
                <div class="leading-xl italic mt-2">
                  Tanimoto Similarity Score is a metric ranging from 0 to 1 that quantifies the similarity between two molecular fingerprints, where 1 indicates identical structures. The top 10 matches for the input substrate are shown below.
                </div>
              </div>
            }
            @case ('fragment') {
              <div>
                <div class="leading-xl">What results are returned?</div>
                <div class="leading-xl italic mt-2">
                  All substrates with matching fragments are returned. Matches are listed from largest to smallest fragment.
                </div>
              </div>
            }
          }
        </div>
      </div>
    </div>
    }
  </p-panel>

  <div class="flex flex-col h-full">
    <div class="my-4">
      <p-panel>
        <ng-template pTemplate="header">
          <span class="grow">Experimental Data</span>
          <div class="flex items-center gap-2">
            <button class="btn-outline !flex items-center gap-2" (click)="showFilter = !showFilter">
              <i class="pi pi-filter"></i>
              <h6 class="inline leading-lg">Filter</h6>
            </button>
            <button class="btn-outline" (click)="clearAllFilters()">
              Clear All
            </button>
          </div>
        </ng-template>

        <div class="flex flex-col">
          @if (hasFilter) {
          <div id="container-filters" class="flex flex-col gap-2 w-full gap-4 p-2 px-4 bg-white">
            <div class="font-semibold">Current Filters</div>
            <div class="flex gap-2">
              @for (filter of filterRecords; track filter.label) {
              @if (filter.hasFilter()) {
              <span class="rounded-sm bg-[--surface-d] p-1 flex items-center gap-1">
                <div [innerHTML]="filter.label.value" class="font-semibold"></div>: {{
                filter.formattedValue }}
                <i class="pi pi-times-circle cursor-pointer" (click)="
                                                filter.value = filter.defaultValue;
                                                applyFilters();
                                            "></i>
              </span>
              }
              }
            </div>
          </div>

          <hr />
          }

          <div class="flex w-full">
            <p-table #resultsTable [value]="result.data" [rows]="10" [rowsPerPageOptions]="[10, 20, 50]"
              [paginator]="true" dataKey="iid" class="w-full h-full" tableStyleClass="w-full" styleClass="w-full"
              [columns]="columns">
              <ng-template pTemplate="header">
                <tr>
                  @for (filter of filters.entries(); track filter[0]) {
                    @let value = filter[1];
                    <th class="align-middle relative group w-[10%]" pSortableColumn="{{ value.field }}">
                      <div [innerHTML]="value.label.value"></div>
                      <p-sortIcon
                        class="absolute top-0 right-0 p-2 text-[#6C757D] [.p-highlight_&]:!visible invisible group-hover:visible"
                        [field]="value.field" />
                    </th>  
                  }
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-row let-expanded="expanded">
                <tr class="table-row">
                  @for (filter of filters.entries(); track filter[0]) {
                    @let value = filter[1];
                    @switch (value.field) {
                      @case ('compound.name') {
                        <td class="align-middle">
                          <div class="flex items-start gap-2">
                            <button title="Expand" type="button" [pRowToggler]="row">
                              <i [class]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></i>
                            </button>
                            <a [routerLink]="['/query/compound', row.compound.name]" class="text-blue-500 cursor-pointer">{{ row.compound.name }}</a>
                          </div>
                        </td>
                      }
                      @case ('organism') {
                        <td class="align-middle italic">
                          {{ row[value.field] }}
                        </td>
                      }
                      @case ('uniprot_id') {
                        <td class="align-middle">
                          <a [routerLink]="['/query/uniprot', row.uniprot_id[0]]" class="text-blue-500 cursor-pointer">{{ row.uniprot_id }}</a>
                        </td>
                      }
                      @case ('ec_number') {
                        <td class="align-middle">
                          <a [routerLink]="['/query/ec', row.ec_number]" class="text-blue-500 cursor-pointer">{{ row.ec_number }}</a>
                        </td>
                      }
                      @case ('kcat') {
                        <td class="align-middle">
                          @if (row.kcat) {
                          {{ row.kcat | number: '1.1-4' }}
                          } @else {
                          <span class="opacity-25">N/A</span>
                          }
                        </td>
                      }
                      @case ('km') {
                        <td class="align-middle">
                          @if (row.km) {
                          {{ row.km | number: '1.1-4' }}
                          } @else {
                          <span class="opacity-25">N/A</span>
                          }
                        </td>
                      }
                      @case ('kcat_km') {
                        <td class="align-middle">
                          @if (row.kcat_km) {
                          {{ row.kcat_km | number: '1.1-4' }}
                          } @else {
                          <span class="opacity-25">N/A</span>
                          }
                        </td>
                      }
                      @case ('pubmed_id') {
                        <td class="text-end align-middle">
                          <app-external-link
                            class="justify-end"
                            [linkItem]="{
                              url: 'https://pubmed.ncbi.nlm.nih.gov/' + row.pubmed_id,
                              label: row.pubmed_id
                            }"
                          ></app-external-link>
                        </td>
                      }
                      @default {
                        <td class="align-middle">
                          {{ row[value.field] }}
                        </td>
                      }
                    }
                  }
                </tr>
              </ng-template>
              <ng-template pTemplate="rowexpansion" let-row>
                <tr>
                  <td colspan="11" class="relative overflow-hidden no-scrollbar bg-[#F7FAFF] !p-2">
                    <div [@slideIn]
                      class="rounded-md border border-[--surface-d] border-solid bg-white p-2 w-full flex flex-col gap-3">
                      <div class="flex flex-col gap-4">
                        <h6 class="font-semibold">Experiment Information</h6>
                        <div class="flex gap-16">
                          <div class="flex flex-col gap-2">
                            <div>Organism</div>
                            <div class="font-semibold italic text-blue-500">{{ row.organism }}</div>
                          </div>
                          <div class="flex flex-col gap-2">
                            <div>Uniprot ID</div>
                            <app-external-link 
                              [linkItem]="{ 
                                url: 'https://www.uniprot.org/uniprot/' + row.uniprot_id, 
                                label: row.uniprot_id
                              }"
                            ></app-external-link>
                          </div>
                          <div class="flex flex-col gap-2">
                            <div>Enzyme Sequence</div>
                            <div class="font-semibold italic text-blue-500">{{ row.enzyme_sequence }}</div>
                          </div>
                          <div class="flex flex-col gap-2">
                            <div>EC Number</div>
                            <app-external-link 
                              [linkItem]="{ 
                                url: 'https://enzyme.expasy.org/EC/' + row.ec_number, 
                                label: row.ec_number
                              }"
                            ></app-external-link>
                          </div>
                          <div class="flex flex-col gap-2">
                            <div>PubMed ID</div>
                            <app-external-link
                              [linkItem]="{
                                url: 'https://pubmed.ncbi.nlm.nih.gov/' + row.pubmed_id,
                                label: row.pubmed_id
                              }"
                            ></app-external-link>
                          </div>
                        </div>
                      </div>
                      <div class="grid grid-cols-2 gap-2">
                        <h6 class="grid-cols-1 col-span-1 font-semibold">Compound Structure</h6>
                        <h6 class="grid-cols-2 col-span-1 font-semibold">Enzyme Structure</h6>
                        <app-molecule-image
                          #molecule2d
                          class="grid-cols-1 col-span-1 h-full rounded-md border border-solid border-[#DEE2E6] p-2 flex items-center justify-center"
                          [smiles]="row.compound.smiles"
                          [width]="300"
                          [height]="200"
                        ></app-molecule-image>
                        <app-molecule3d
                          #molecule3d
                          class="grid-cols-2 col-span-1 h-full rounded-md border border-solid border-[#DEE2E6] p-1" 
                          [options]="{
                              data: row.uniprot_id[0],
                              dataType: 'uniprot',
                              viewerOptions: {
                                  mode: 'cartoon',
                                  modeConfig: {
                                    color: 'spectrum'
                                  }
                              }
                          }">
                        </app-molecule3d>
                      </div>
                      <div>
                        <h6 class="font-semibold">Reaction Schema</h6>
                        <p>{{ row.reaction }}</p>
                      </div>
                    </div>
                  </td>
                </tr>
              </ng-template>

              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="11" class="text-center">
                    <div class="flex flex-col items-center justify-center h-full gap-4 p-8">
                      <h5 class="font-semibold text-center">Empty</h5>
                      <p class="text-center">No kinetic data found. Please try a new search.</p>
                    </div>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </p-panel>
    </div>
  </div>

  <app-filter-dialog [(visible)]="showFilter" [filters]="filters"
    [numberResults]="$any(resultsTable)?.filteredValue?.length ?? result.total" (filterChange)="searchTable($event)"
    (clearAllFilters)="clearAllFilters()" (applyFilters)="applyFilters()">
  </app-filter-dialog>
</div>